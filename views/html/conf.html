<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
        <title>OTU: configure that thing</title>

        $$HEAD_CONTENT$$

        <style>
#format {
    margin-top: 2em;

} body {
    padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
}
        </style>
    </head>
    <body>
        
        $$NAVBAR$$
        
        <div class="container">
            <form>
                <fieldset>
                    <legend>Configuration Information</legend>
                    <label>Nexson Git Directory</label>
                    <div id="divgitdir">
                        <input type="text" id="gitdir" name="gitdir" class="input-xxlarge" value="" />
                            <span class="help-block">
                                This is the directory to the avatol_nexson git directory.
                                <br/> You can leave this empty
                            </span>
                        <button type="submit" class="btn" onClick="setConf()">Submit</button>
                    </div>
                </fieldset>
            </form>
            <form>
                <fieldset>
                    <legend>Install OTT taxonomy</legend>
                    <span class="help-block" id="statusMessage"></span>
                    <button type="button" class="btn btn-medium" name="loadOTT" id="loadOTTButton">Load OTT</button>
                </fieldset>
            </form>
        </div>
        <script>

///////////////////////////////////
//
//
//     nexson git dir
//
//
//

function editConf(){
    var st = $("#hiddengitdir").val();
    $("#divgitdir").replaceWith('<div id="divgitdir">');
    $("#divgitdir").append('<input type="text" id="gitdir" name="gitdir" class="input-xxlarge" value=\''+st+'\'>');
    $("#divgitdir").append('<span class="help-block">This is the directory to the avatol_nexson git directory. <br/> You can leave this empty</span>');
    $("#divgitdir").append('<button type="submit" class="btn" onClick="setConf()">Submit</button>');
    $("#divgitdir").append('</div>');
}

function setConf(){
    var st = $("#gitdir").val();
    var baseurl = "http://localhost:7474/db/data/ext/ConfigurationPlugins/graphdb/setNexsonGitDir";
    var method = "POST";
    var senddata = "{\"nexsongitdir\":\""+st+"\"}";
    var xobjPost = new XMLHttpRequest();
    xobjPost.open(method, baseurl, false);
    xobjPost.setRequestHeader("Accept", "");
    xobjPost.setRequestHeader("Content-Type","application/json");
    xobjPost.send(senddata);
    var jsonrespstr = xobjPost.responseText;
    var evjson = eval(jsonrespstr);
    location.reload();
}

function getConf(){
    var nexsonDirService = "http://localhost:7474/db/data/ext/ConfigurationPlugins/graphdb/getNexsonGitDir";
    var xhr = getXhr(nexsonDirService, function() {
        var response = JSON.parse(xhr.responseText);
        
      	var dir = response.nexsongitdir;
        $("#divgitdir")
            .html('<input type="hidden" value=\''+dir+'\' id="hiddengitdir" name="#hiddengitdir"/><strong><p class="text-info">'+dir+'</p></strong>')
            .append('<span class="help-block">This is the directory to the avatol_nexson git directory. <br/> You can leave this empty</span>')
            .append('<button type="button" class="btn" onClick="editConf()">Edit</button>')
            .append('</div>');
        
    });
    xhr.send();
}

///////////////////////////////////
//
//
//     load ott
//
//
//

function loadOTT() {

    var installOTTService = "http://localhost:7474/db/data/ext/ConfigurationPlugins/graphdb/installOTT";
    var xhr = getXhr(installOTTService, function() {
        var response = JSON.parse(xhr.responseText);
        if (response.event == "success") {
            setGraphProperty("has_taxonomy", "true", "boolean", function() {
                updateLoadOTTForm(response);
                $("#statusMessage").html("<p>OTT was loaded successfully.</p>");
            });
        }
    }, true);
    
    // TODO: make this variable set by a python script that will download the OTT file.
    // Call this function on page load as a callback if some incoming form variable indicates to do so.
    xhr.send(JSON.stringify({taxonomyFile:"/home/cody/phylo/data/ott2.2/taxonomy"}));
    $("#statusMessage").html("<p>Your request to load the taxonomy has been submitted. This will take some time. This page will be updated when the load is complete. Please leave this page open.</p>");
}

function connectExistingTreesToOTT() {

    $("#statusMessage").append("<p>Now connecting taxonomy to previously loaded trees.</p>");

    var installOTTService = "http:/localhost:7474/db/data/ext/ConfigurationPlugins/graphdb/connectAllTreesToOTT";
    var xhr = getXhr(installOTTService, function() {
        var response = JSON.parse(xhr.responseText);
        if (response.event == "success") {
            $("#statusMessage").append("<p>Connecting to trees is done. The taxonomy has been fully installed. Trees will be connected upon loading and upon assignment to taxa.</p>");
        }
    });
}

function updateLoadOTTForm(response) {
    if (response["has_taxonomy"] == true) {
        $("#statusMessage").html("The OTT taxonomy has already been loaded.");
        $("#loadOTTButton").addClass(" disabled").attr("disabled","disabled").unnbind("click");
    }
}

///////////////////////////////////
//
//
//     onload
//
//
//

$(document).ready(function() {
    
    // activate load ott button
    $("#loadOTTButton").click(loadOTT);
    
    getGraphProperty("has_taxonomy", updateLoadOTTForm);
    
    $("#radio").buttonset();
    getConf();
});

        </script>
    </body>
</html>

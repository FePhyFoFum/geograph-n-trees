<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
    <head>
        <title>OTU: look at that source</title>

        $$HEAD_CONTENT$$

        <style>
body {
    padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */

/*} .treeHeader {
    position: relative;
    border: 1px solid red;

} .treeHeader * {
    position: relative; */

} #editSourceBtn, .editTreeBtn {
    width: 10em;

} #loadFormContainer {
    position: absolute;
    top: 6.7em;
    right:3em;
    width: 22em;
    padding-right:0em;

} .submitTreeEditsBtn, #submitSourceEditsBtn {
    position: absolute;
    top: 0;
    right: 0;

} .deleteTreeBtn {
    position: absolute;
    top: 0;

} #statusReport {
/*    padding: 0.2em 0 0.2em 0.4em; */

} #format {
    margin-top: 2em;

} .editForm {
    position: relative;

} .editForm * {
    margin-right: 0.22em;

} .formTable {
    margin-top: 0.8em;

} .formTable tr td .form-control {
    font-size: 1em;
    width: 100%;
    margin: 0;

} form tr td input {
    padding: 0.8em 0.4em 0.8em 0.4em;
    height: 1.7em !important;

} form tr td textarea {
    height: 6em;

} form .hidden {
    display: none !important;
    position: absolute !important;
}
        </style>
    </head>
    <body>
        
        $$NAVBAR$$
        
        <div class="container">
            <div id="loadFormContainer">
                Load a different source...
	            <form class="form-inline" >
	                <select id="loadselect" style="width: 16em"></select>
	                <button id="loadselectBtn" type="button" class="btn" onClick='loadDifferentSource()'>Load</button>
	            </form>
            </div>
            <h3 id="sourceTitle"></h3>
	        <button type="button" class="btn btn-medium " name="cac" value=1 id="exportBtn">Export to file</button>
	        <button type="button" class="btn btn-medium " name="cac" value=0 id="editSourceBtn">Edit metadata</button>
	        <button type="button" class="btn btn-medium " name="cac" value=3 id="deleteSourceLocalBtn">Delete local copy</button>
	        <div class="btn-group">
    	        <button type="button" class="btn btn-medium  disabled" name="cac" value=2 id="pushSourceBtn">Push changes</button>
    	        <button type="button" class="btn btn-medium  disabled" name="cac" value=3 id="deleteSourceGitBtn">Delete from public repo</button>
	        </div>
            <br/>
            <br/>
            <form id="sourceEditForm" style="position: relative;">
                <div id="statusReport"></div>
                <button name="submitSourceEditsBtn" id="submitSourceEditsBtn" type="button" class="btn btn-medium btn-success hidden">Save changes</button>
                <table class="table table-striped formTable" id="sourceInfoTable"></table>
            </form>
            <div id="treeInfo"></div>
        </div>
    </div>
    <script>

// called on page load to fill in the dropdown selector for studies
function populateSourceListDropdown() {
    var sourcelinkurl ="../source_view.html?sourceId="
    var sourceListService = "http://localhost:7474/db/data/ext/sourceJsons/graphdb/getSourceList";
    var xhr = getXhr(sourceListService, function() {
        var response = JSON.parse(xhr.responseText);
        $(response.sources).each(function(i, sourceId) {
            $('#loadselect').append('<option value=' + sourceId + '> sourceId:' + sourceId + '</option>');
        });
    });
    xhr.send(JSON.stringify({"excludedSourceIds":[ activeSourceId ]}));
}

// called on page load to fill in the page content using content from neo4j services
function displaySourceInfo() {
    var sourceMetadataService = "http://localhost:7474/db/data/ext/sourceJsons/graphdb/getSourceMetaData";

    // set the callback, which will print the result of the request
    var xhr = getXhr(sourceMetadataService, function() { 
        var response = JSON.parse(xhr.responseText);

        // exit early if there is no result
        if (!response.metadata) {
            
            // specify that nothing was found if we do in fact have a source id
            if (activeSourceId != "undefined") {
                $("#sourceTitle").html("No source found");
            }
            
            $("button").each(function(i, element) {
                if ($(element).attr("id") != "loadselectBtn") {
                    $(element).addClass("disabled").click(undefined);
                }
            });
            
            return; // exit early
        };
        
        // set event handlers here so the buttons remain inactive if there is no result
	    $("#exportBtn").click(function() { exportSource() });
        $("#editSourceBtn").click(function() { toggleSourceEditForm() });
	    $("#deleteSourceLocalBtn").click(function() { deleteSourceLocal() });
//	    $("#pushSourceBtn").click(function() { pushSource() });
//	    $("#deleteSourceGitBtn").click(function() { deleteSourceGit() });
	    $("#submitSourceEditsBtn").click(function() { submitSourceEditForm() });
        
        var keys = Object.keys(response.metadata);
        
        // print the source properties to the table
        $(keys).each(function(i, property){
            var value = response.metadata[property];
            var link;
            if (typeof value == "string") {
                if(value.substring(0,7) == "http://") {
                    link = '<a href="' + value + '", target="_blank">' + value + '</a>';
                }
            }

            // append a row for each property
            $("#sourceInfoTable").append(getFormTableRow(property, value, link));
        });
        
        // TODO: update the status message about this source
        $("#statusReport").append("Status: info about mapped names, rooting, ingroup, X% complete will go here");
        
        // add the trees
        $(response.trees).each(function(i, treeId) {
            displayTreeInfo(treeId);
        });
    });

    // send the request
    xhr.send(JSON.stringify({ "sourceId": activeSourceId }));
}

// called for each tree during printout of the metadata
function displayTreeInfo(treeId) {
    var treeInfoService = "http://localhost:7474/db/data/ext/treeJsons/graphdb/getTreeMetaData";
    var xhr = getXhr(treeInfoService, function() {

        // create the form and add initial elements
        var formId = "treeEditForm" + treeId;
        var response = JSON.parse(xhr.responseText);
        var treeForm = $(document.createElement("form")) //); //.addClass("treeHeader");

        // write the header for this tree
//        $(treeForm)
            .addClass("editForm")
//            .append($("<form>")
            .attr("id",formId)
//            .append($(document.createElement("a"))
//                .attr("href","tree_view.py?treeId=" + treeId)
//                .append(treeId))
                .append($(document.createElement("button"))
                    .attr("type", "button")
                    .addClass("btn btn-medium doNotHide")
                    .click(function() { window.location.href="tree_view.py?treeId=" + treeId; })
                    .append("View tree"))
                .append($(document.createElement("button"))
                    .attr("type","button")
                    .addClass("btn btn-medium doNotHide editTreeBtn")
                    .click(function() { toggleTreeEditForm($("#"+formId)) })
                    .append("Edit metadata"))
                .append($(document.createElement("button"))
                    .attr("type","button")
                    .addClass("btn btn-medium doNotHide deleteTreeBtn")
                    .click(function() { deleteTree(treeId) })
                    .append("Delete tree"))
                .append($(document.createElement("input"))
                    .attr("type","hidden")
                    .attr("name","treeId")
                    .val(treeId))
                .append($(document.createElement("button"))
                    .addClass("btn btn-medium btn-success hidden submitTreeEditsBtn")
                    .attr("type","button")
                    .append("Save changes")
                    .click(function() { submitTreeEditForm(treeId, formId) }));

//        $(treeForm).append(treeHeader);
            
        // create the metadata table
        var keys = Object.keys(response.metadata);
        var treeTable = $(document.createElement("table"))
            .addClass("table table-striped formTable")
            .attr("id", "treeTable" + treeId);

        // write all properties to the table
        $(keys).each(function(i, property) {
            var value = response.metadata[property];
            $(treeTable).append(getFormTableRow(property, value));
        });

        // add the tree metadata to the page
        $(treeForm).append(treeTable);
        $("#treeInfo").append($("<h4>").append("Tree " + treeId)).append(treeForm);
    });
    
    xhr.send(JSON.stringify({"treeId": treeId}));
}

// called by the form building functions
function getFormTableRow(property, value, displayValue) {

    // make hidden form elements to toggle for editing
    var formControl;
    if (value.length < 80 || value.length == undefined) {
        formControl = $("<input>").attr("value",value).attr("type","text");
    } else {
        formControl = $("<textarea>").append(value);
    }
    $(formControl).addClass("form-control hidden").attr("name", property);
    
    // create a row for this property
    var row = $("<tr>")
        .append($("<td>")
            .attr("width","250px")
            .append(property))
        .append($("<td>")
            .addClass("fieldCell")
            .append($("<span>").addClass("displayValue").append(displayValue ? displayValue : value))
            .append(formControl));

    return row;
}

// ===== functions bound to page buttons and forms

// called by the source selector dropdown
function loadDifferentSource() {
    var sourceId = $("#loadselect").val();
    window.location.href="source_view.py?sourceId=" + sourceId + ""
}

function toggleSourceEditForm() {

    toggleEditForm("#sourceEditForm");

    if (! $("#editSourceBtn").hasClass("btn-warning")) {
        $("#editSourceBtn").addClass(" btn-warning").html("Cancel edits");
    } else {
        $("#editSourceBtn").removeClass("btn-warning").html("Edit metadata");
    } 
}

function toggleTreeEditForm(treeEditForm) {

    toggleEditForm(treeEditForm);

    if (! $(treeEditForm).find(".editTreeBtn").hasClass("btn-warning")) {
        $(treeEditForm).find(".editTreeBtn").addClass(" btn-warning").html("Cancel edits");
    } else {
        $(treeEditForm).find(".editTreeBtn").removeClass("btn-warning").html("Edit metadata");
    } 
}

function toggleEditForm(formElement) {
//    alert(formElement);
    $(formElement).find(".fieldCell .displayValue").each(function(i, display) {
        $(display).hasClass("hidden") ? $(display).removeClass(" hidden") : $(display).addClass(" hidden");
    });
    $(formElement).find(".fieldCell .form-control").each(function(i, input) { 
        $(input).hasClass("hidden") ? $(input).removeClass(" hidden") : $(input).addClass(" hidden");
    });
    $(formElement).find("button").each(function(i, button) {
        if ($(button).hasClass("hidden")) {
            $(button).removeClass(" hidden")
        } else if (! $(button).hasClass("doNotHide")) {
            $(button).addClass(" hidden");
        }
    });
}

// submit the values from the source editing form to be stored as properties in the graph
function submitSourceEditForm() {

    var sourceMetaNodeIdService = "http://localhost:7474/db/data/ext/sourceJsons/graphdb/getNodeIdForSourceId";
    var xhr = getXhr(sourceMetaNodeIdService, function() {

        var sourceMetaNodeId = JSON.parse(xhr.responseText);
        submitPropertyEdits(sourceMetaNodeId, $("#sourceEditForm"));
        
    });
    
    // initiate the request for the source meta node id
    xhr.send(JSON.stringify({"sourceId": activeSourceId}));
}

function submitTreeEditForm(treeId, formId) {
    var sourceMetaNodeIdService = "http://localhost:7474/db/data/ext/treeJsons/graphdb/getRootNodeIdForTreeId";
    var xhr = getXhr(sourceMetaNodeIdService, function() {

        var treeRootNodeId = JSON.parse(xhr.responseText);
        submitPropertyEdits(treeRootNodeId, $("#"+formId));
        
    });
    
    // initiate the request for the source meta node id
    xhr.send(JSON.stringify({"treeId": treeId}));
}

function submitPropertyEdits(nodeId, propertyForm) {
    
    var submitPropertyEditsService = "http://localhost:7474/db/data/ext/sourceJsons/node/" + nodeId + "/setBasicProperties";
    var xhr = getXhr(submitPropertyEditsService, function() {
        location.reload();
    });

    var keys = [];
    var values = [];
    var types = [];
    $(propertyForm).find(".fieldCell .form-control").each(function(i, input) {
        keys.push(input.name);
        values.push(input.value);
        types.push(typeof input.value);
    });
    
    // send the property edit request using the source meta node id
    xhr.send(JSON.stringify({"keys": keys, "values": values, "types": types}));
}

function editTreeInfo(treeId) {
    alert("this will edit the tree metadata");
    // replace the tree metadata view with a form, turn all the fields to input boxes
    // submit the form to post to a property-updating service
}

function exportSource() {
    alert("this will export the source");
}

function pushSource() {
    alert("this will push the source (after comparing to the git)");
}

function deleteSourceLocal() {

    var proceed = confirm("Are you sure you want to remove this source? There is no way to undo this action and all changes that have not been pushed will be lost.");
    if (! proceed) { return; }

    var deleteLocalSourceService = "http://localhost:7474/db/data/ext/sourceJsons/graphdb/deleteSourceFromSourceId";
    xhr = getXhr(deleteLocalSourceService, function() {
//        var response = JSON.parse(xhr.responseText);
        var confirmForm = $(document.createElement("form"))
            .attr("action", "load_sources.py")
            .attr("method", "POST")
            .append($(document.createElement("input"))
                .attr("type", "hidden")
                .attr("name", "deleted_source_id")
                .val(activeSourceId));
            
        $(confirmForm).submit();
            
    });
    xhr.send(JSON.stringify({"sourceId": activeSourceId}));
}

function deleteSourceGit() {
    alert("this will delete the source from git. There should be a very explicit and terrifying warning and at least one level of confirmation required to do this. Would also be good to have people re-enter their password");
}

function deleteTree(treeId) {

    var proceed = confirm("Are you sure you want to remove this tree? There is no way to undo this action.");
    if (! proceed) { return; }

    var treeDeleteService = "http://localhost:7474/db/data/ext/treeJsons/graphdb/deleteTreeFromTreeId";
    var xhr = getXhr(treeDeleteService, function() {
        response = JSON.parse(xhr.responseText);
        location.reload();
    });
    xhr.send(JSON.stringify({"treeId": treeId}));
}

// ===== on page load

var activeSourceId; // page global
$(document).ready(function() {

    // get the source id from the GET variables
    activeSourceId = getQueryVariable('sourceId');

    if (! activeSourceId) {
        // set this to a string so it is accepted by various services that
        // need to be called whether we have a source or not
        activeSourceId = "undefined";
        $("#sourceTitle").append("No source specified");
    } else {
        $("#sourceTitle").append("Viewing source " + activeSourceId);
    }
    
    populateSourceListDropdown();
    displaySourceInfo();

});

    </script>
</body>
</html>
